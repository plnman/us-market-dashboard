<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Market - AI Stock Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            overflow: hidden;
            /* Prevent full page scroll */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .koyfin-border {
            border-color: #2a2a2a;
        }

        .koyfin-header-bg {
            background-color: #121212;
        }

        .koyfin-panel-bg {
            background-color: #121212;
            /* Main background */
        }

        .koyfin-card-bg {
            background-color: #121212;
            /* Cards blend in or slightly lighter if needed, but Koyfin is flat */
        }

        .koyfin-green {
            color: #00E396;
        }

        .koyfin-red {
            color: #FF4560;
        }

        /* Tab Styling */
        .nav-tab {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: #fff;
        }

        .nav-tab.active {
            color: #fff;
            border-bottom-color: #fff;
            /* White underline for active tab */
            font-weight: 600;
        }

        /* Table Styling */
        .koyfin-table th {
            font-weight: 500;
            color: #888;
            font-size: 11px;
            padding: 8px;
            border-bottom: 1px solid #2a2a2a;
            text-align: right;
        }

        .koyfin-table th:first-child {
            text-align: left;
        }

        .koyfin-table td {
            padding: 8px;
            font-size: 12px;
            border-bottom: 1px solid #1f1f1f;
            text-align: right;
        }

        .koyfin-table td:first-child {
            text-align: left;
        }

        .koyfin-table tr:hover td {
            background-color: #1a1a1a;
        }

        /* Style Box Grid */
        .style-box-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #121212;
            /* Text color on colored bg */
            border: 1px solid #121212;
            /* Grid lines */
        }

        /* Utility for dense layout */
        .text-xxs {
            font-size: 10px;
        }
    </style>
</head>

<body class="flex flex-col h-screen w-screen text-sm bg-[#121212]">
    <!-- Top Navigation Bar -->
    <header class="h-14 border-b koyfin-border flex items-center px-4 justify-between shrink-0 bg-[#121212]">
        <div class="flex items-center gap-4">
            <!-- Sidebar Toggle / Menu -->
            <button class="text-gray-400 hover:text-white"><i class="fas fa-bars"></i></button>
            <!-- Breadcrumb / Title Area -->
            <div class="flex items-center gap-2 text-sm">
                <button class="text-gray-500 hover:text-white flex items-center gap-1 text-xs font-medium">
                    <i class="fas fa-chevron-left"></i> Back
                </button>
                <div class="h-4 w-px bg-[#333] mx-2"></div>
                <h1 id="main-header-title" class="text-lg font-bold text-white tracking-tight">ğŸ‡ºğŸ‡¸ US Market</h1>
            </div>
        </div>
        <!-- Search Bar -->
        <div class="flex-1 max-w-xl mx-8">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-600 group-focus-within:text-blue-500"></i>
                </div>
                <input type="text"
                    class="block w-full pl-10 pr-3 py-1.5 border border-[#333] rounded bg-[#1a1a1a] text-gray-300 placeholder-gray-600 focus:outline-none focus:border-blue-600 focus:ring-1 focus:ring-blue-600 sm:text-sm transition-colors"
                    placeholder="Search for a name, ticker, or function (/)">
                <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                    <span class="text-gray-600 text-xs border border-[#333] rounded px-1.5">/</span>
                </div>
            </div>
        </div>
        <!-- Action Buttons -->
        <div class="flex items-center gap-2">
            <button
                class="bg-[#1a1a1a] hover:bg-[#2a2a2a] text-gray-300 border border-[#333] px-3 py-1.5 rounded text-xs font-medium flex items-center gap-2 transition-colors">
                <i class="far fa-file-alt"></i> Create Report
            </button>
            <button
                class="bg-[#1a1a1a] hover:bg-[#2a2a2a] text-gray-300 border border-[#333] px-3 py-1.5 rounded text-xs font-medium flex items-center gap-2 transition-colors">
                <i class="far fa-sticky-note"></i> My Notes
            </button>
            <button
                class="bg-[#1a1a1a] hover:bg-[#2a2a2a] text-gray-300 border border-[#333] px-3 py-1.5 rounded text-xs font-medium flex items-center gap-2 transition-colors">
                <i class="fas fa-share-alt"></i> Share
            </button>
            <button
                class="bg-[#e0e0e0] hover:bg-white text-black border border-transparent px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition-colors">
                <i class="fas fa-pen"></i> Edit Portfolio
            </button>
        </div>
    </header>
    <!-- Tab Navigation -->
    <div class="h-10 border-b koyfin-border flex items-center px-4 gap-1 bg-[#121212] shrink-0">
        <div class="nav-tab" onclick="switchMarketTab(this, 'ğŸ‡°ğŸ‡· KR Market')">ğŸ‡°ğŸ‡· KR Market</div>
        <div class="nav-tab active" onclick="switchMarketTab(this, 'ğŸ‡ºğŸ‡¸ US Market')">ğŸ‡ºğŸ‡¸ US Market</div>
        <div class="nav-tab" onclick="switchMarketTab(this, 'Economic Calendar')">Economic Calendar</div>
        <div class="nav-tab">Historical Returns</div>
        <div class="nav-tab">Risk</div>
        <div class="nav-tab">Holdings Matrix</div>
    </div>
    <!-- Main Content Area (Scrollable) -->
    <main class="flex-1 overflow-auto p-4 bg-[#121212]">
        <!-- KR Market Content -->
        <div id="content-kr-market" class="hidden">
            <section class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-bold text-gray-300">Market Indices</h2>
                    <span class="text-xs text-gray-500">Real-time Data</span>
                </div>
                <!-- ... (KR Market HTML Content) ... -->
                <div class="bg-gray-900 border border-gray-800 rounded p-4 text-center text-gray-400 text-sm">
                    KR Market content placeholder (Focus is on US Market for now)
                </div>
            </section>
        </div>
        <!-- US Market Content -->
        <div id="content-us-market">
            <!-- Market Indices Section -->
            <section class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-bold text-gray-300">ğŸ‡ºğŸ‡¸ US Market Indices</h2>
                    <div class="flex items-center gap-3">
                        <div id="lang-toggle" class="flex items-center gap-1 bg-[#2a2a2a] rounded-full p-0.5">
                            <button data-lang="ko"
                                class="px-2 py-0.5 text-xs rounded-full bg-blue-600 text-white transition-colors">í•œêµ­ì–´</button>
                            <button data-lang="en"
                                class="px-2 py-0.5 text-xs rounded-full text-gray-400 hover:text-white transition-colors">English</button>
                        </div>
                        <span class="text-xs text-gray-500">Real-time Data</span>
                    </div>
                </div>
                <div id="us-market-indices-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <!-- Populated by JS -->
                    <div
                        class="bg-[#1a1a1a] border border-[#2a2a2a] rounded p-3 flex flex-col items-center justify-center h-20 animate-pulse">
                        <div class="h-3 w-16 bg-[#2a2a2a] rounded mb-2"></div>
                        <div class="h-4 w-20 bg-[#2a2a2a] rounded"></div>
                    </div>
                </div>
            </section>
            <!-- US Stock Chart Section -->
            <section class="mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Chart -->
                    <div class="lg:col-span-2 bg-[#1a1a1a] border border-[#2a2a2a] rounded p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h2 id="us-chart-ticker" class="text-lg font-bold text-white">Select a stock</h2>
                                <span id="us-chart-info" class="text-xs text-gray-400">Click on a stock from the table
                                    below</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="us-chart-period-btns" class="flex gap-1">
                                    <button data-period="1mo"
                                        class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-blue-600 hover:text-white transition-colors">1M</button>
                                    <button data-period="3mo"
                                        class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-blue-600 hover:text-white transition-colors">3M</button>
                                    <button data-period="6mo"
                                        class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-blue-600 hover:text-white transition-colors">6M</button>
                                    <button data-period="1y"
                                        class="px-2 py-1 text-xs rounded bg-blue-600 text-white">1Y</button>
                                    <button data-period="max"
                                        class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-blue-600 hover:text-white transition-colors">ALL</button>
                                </div>
                                <div id="us-chart-grade"
                                    class="px-3 py-1 rounded text-sm font-bold bg-gray-700 text-gray-300">-</div>
                            </div>
                        </div>
                        <div id="us-stock-chart" class="h-[300px] flex items-center justify-center text-gray-500">
                            <i class="fas fa-chart-line text-3xl"></i>
                        </div>
                        <!-- Technical Indicator Toggles -->
                        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-700">
                            <span class="text-xs text-gray-500">Indicators:</span>
                            <button id="toggle-bb" onclick="toggleIndicator('bb')"
                                class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-purple-600 transition-colors">ğŸ“Š
                                BB</button>
                            <button id="toggle-sr" onclick="toggleIndicator('sr')"
                                class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-orange-600 transition-colors">ğŸ“
                                S/R</button>
                            <button id="toggle-rsi" onclick="toggleIndicator('rsi')"
                                class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-green-600 transition-colors">ğŸ“ˆ
                                RSI</button>
                            <button id="toggle-macd" onclick="toggleIndicator('macd')"
                                class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-blue-600 transition-colors">ğŸ“‰
                                MACD</button>
                        </div>
                        <!-- RSI Sub-Chart -->
                        <div id="us-rsi-chart" class="hidden h-[80px] mt-2 border-t border-gray-700 pt-2"></div>
                        <!-- MACD Sub-Chart -->
                        <div id="us-macd-chart" class="hidden h-[80px] mt-2 border-t border-gray-700 pt-2"></div>
                    </div>
                    <!-- Sector Heatmap -->
                    <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold text-gray-400"><i
                                    class="fas fa-globe-americas text-blue-400 mr-1"></i> Market Map</h3>
                            <span id="us-heatmap-date" class="text-xs text-gray-500"></span>
                        </div>
                        <div id="us-sector-heatmap" class="w-full h-[300px] relative">
                            <!-- ApexCharts Treemap will be rendered here -->
                            <div class="flex items-center justify-center h-full text-xs text-gray-500">Loading Market
                                Map...</div>
                        </div>
                    </div>
                </div>
                <!-- AI Summary Section -->
                <div class="mt-4 bg-[#1a1a1a] border border-[#2a2a2a] rounded p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-bold text-purple-400" data-i18n="ai-analysis">ğŸ¤– AI íˆ¬ì ë¶„ì„</h3>
                        <span id="us-ai-updated" class="text-xs text-gray-500"></span>
                    </div>
                    <div id="us-ai-summary" class="text-sm text-gray-300">
                        <div class="mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-semibold text-purple-300">ğŸ“Š ì¢…í•© ë¶„ì„</span>
                            </div>
                            <p id="ai-main-analysis" class="text-sm leading-relaxed mb-2 text-gray-300">
                                ì¢…ëª©ì„ ì„ íƒí•˜ë©´ AI ë¶„ì„ì´ í‘œì‹œë©ë‹ˆë‹¤.
                            </p>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-3 pt-3 border-t border-gray-700">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">ğŸ’¡ íˆ¬ì í¬ì¸íŠ¸</div>
                                <div id="ai-key-points" class="text-xs text-gray-400">-</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">âš ï¸ ë¦¬ìŠ¤í¬ ìš”ì¸</div>
                                <div id="ai-risks" class="text-xs text-gray-400">-</div>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <div class="text-xs text-gray-500 mb-1">ğŸ¯ AI ì¶”ì²œ</div>
                            <div id="ai-recommendation" class="text-sm font-semibold text-yellow-400">-</div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Smart Money Picks Section -->
            <section class="mb-6">
                <!-- ... (Smart Money Picks Content) ... -->
                <div class="bg-[#1a1a1a] border border-[#2a2a2a] rounded p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <h2 class="text-sm font-bold text-gray-300" data-i18n="final-top10">ğŸ“Š Final Top 10 - Smart
                                Money Picks</h2>
                            <p class="text-xs text-gray-500 mt-1">
                                AIì™€ í€€íŠ¸ ë¶„ì„ì„ ê²°í•©í•˜ì—¬ ì„ ì •í•œ ìƒìœ„ 10ê°œ ì¢…ëª©. ê¸°ê´€ ìê¸ˆ íë¦„, ê¸°ìˆ ì  ì§€í‘œ, AI ì¶”ì²œì„ ì¢…í•© í‰ê°€í•©ë‹ˆë‹¤.
                            </p>
                            <select id="us-history-date-select"
                                class="bg-[#1a1a1a] border border-[#2a2a2a] rounded px-2 py-1 text-xs text-gray-300"
                                onchange="loadUSHistoryByDate(this.value)">
                                <option value="">ğŸ“… ë‚ ì§œ ì„ íƒ</option>
                            </select>
                            <button id="update-data-btn" onclick="updateAllData()"
                                class="px-2 py-1 text-xs rounded bg-blue-600 hover:bg-blue-500 text-white transition-colors flex items-center gap-1">
                                <i class="fas fa-sync-alt" id="update-icon"></i> Update
                            </button>
                            <button id="reanalyze-btn" onclick="reanalyzeData()"
                                class="px-2 py-1 text-xs rounded bg-purple-600 hover:bg-purple-500 text-white transition-colors flex items-center gap-1">
                                <i class="fas fa-brain" id="reanalyze-icon"></i> ì¬ë¶„ì„
                            </button>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span id="us-smart-money-summary" class="text-xs text-gray-500">Loading...</span>
                            <span id="last-update-time" class="text-xs text-gray-600"></span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-[#1a1a1a] text-gray-400 text-xs">
                                    <th class="p-2 text-left">#</th>
                                    <th class="p-2 text-left">Ticker</th>
                                    <th class="p-2 text-center">Sector</th>
                                    <th class="p-2 text-center">Score</th>
                                    <th class="p-2 text-center">AI ì¶”ì²œ</th>
                                    <th class="p-2 text-center">ì¶”ì²œê°€<br><span class="text-gray-600 text-[10px]"
                                            id="rec-date-header"></span></th>
                                    <th class="p-2 text-center">í˜„ì¬ê°€<br><span class="text-gray-600 text-[10px]"
                                            id="current-date-header"></span></th>
                                    <th class="p-2 text-center">ë³€ë™</th>
                                    <th class="p-2 text-center">ëª©í‘œ Upside</th>
                                </tr>
                            </thead>
                            <tbody id="us-smart-money-table">
                                <tr class="animate-pulse">
                                    <td colspan="8" class="p-4 text-center text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- ETF Flows Section -->
            <section class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <h2 class="text-sm font-bold text-gray-300" data-i18n="etf-flows">ğŸ’° ETF Fund Flows - ìê¸ˆ íë¦„</h2>
                        <p class="text-xs text-gray-500 mt-1">
                            ì£¼ìš” ETFì˜ ìê¸ˆ íë¦„ ì ìˆ˜(0~100). OBV, ê±°ë˜ëŸ‰, ê°€ê²© ëª¨ë©˜í…€ì„ ì¢…í•© ë¶„ì„í•˜ì—¬ ìê¸ˆ ìœ ì…/ìœ ì¶œì„ ì¸¡ì •í•©ë‹ˆë‹¤.
                        </p>
                        <button id="us-etf-ai-btn"
                            class="hidden ml-2 px-2 py-0.5 text-xs rounded-full bg-indigo-600 hover:bg-indigo-500 text-white transition-colors">
                            ğŸ¤– AI ë¶„ì„
                        </button>
                    </div>
                    <span id="us-etf-sentiment"
                        class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300">Loading...</span>
                </div>
                <!-- ... (ETF Flows Content) ... -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-[#1a1a1a] rounded border border-[#2a2a2a] p-4">
                        <h3 class="text-xs text-green-400 font-bold mb-2" data-i18n="top-inflows">ğŸ“ˆ Top Inflows</h3>
                        <div id="us-etf-inflows" class="space-y-2"></div>
                    </div>
                    <div class="bg-[#1a1a1a] rounded border border-[#2a2a2a] p-4">
                        <h3 class="text-xs text-red-400 font-bold mb-2" data-i18n="top-outflows">ğŸ“‰ Top Outflows</h3>
                        <div id="us-etf-outflows" class="space-y-2"></div>
                    </div>
                    <div id="us-etf-ai-container"
                        class="hidden mt-4 col-span-2 bg-[#1e1e1e] border border-indigo-500/30 rounded p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">ğŸ§ </span>
                            <span class="text-sm font-bold text-indigo-300">Gemini 3.0 Market Insight</span>
                        </div>
                        <div id="us-etf-ai-content" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">
                        </div>
                    </div>
                </div>
            </section>
            <!-- Options Flow Section -->
            <section class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-bold text-gray-300"><i class="fas fa-chart-area text-orange-400 mr-1"></i>
                        <span data-i18n="options-flow">Options Flow - ê¸°ê´€ í¬ì§€ì…˜</span>
                    </h2>
                    <span id="us-options-timestamp" class="text-xs text-gray-500"></span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="us-options-flow">
                    <div class="text-center text-xs text-gray-500">Loading options...</div>
                </div>
            </section>
            <!-- Macro Analysis Section -->
            <section class="mb-6">
                <!-- ... (Macro Analysis Content) ... -->
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-bold text-gray-300" data-i18n="macro-analysis">ğŸŒ Macro Analysis - AI ì˜ˆì¸¡
                    </h2>
                    <span id="us-macro-timestamp" class="text-xs text-gray-500"></span>
                </div>
                <div class="grid grid-cols-5 md:grid-cols-10 gap-2 mb-4" id="us-macro-indicators">
                    <div class="text-center text-xs text-gray-500">Loading...</div>
                </div>
                <div
                    class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg border border-purple-800/50 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">ğŸ¤–</span>
                            <span id="macro-model-label" class="text-sm font-bold text-purple-300"
                                data-i18n="gemini-macro">Gemini 3.0 ë§¤í¬ë¡œ ë¶„ì„</span>
                        </div>
                        <div id="model-toggle" class="flex items-center gap-1 bg-[#2a2a2a] rounded-full p-0.5">
                            <button data-model="gemini"
                                class="px-2 py-0.5 text-xs rounded-full bg-purple-600 text-white transition-colors">Gemini</button>
                            <button data-model="gpt"
                                class="px-2 py-0.5 text-xs rounded-full text-gray-400 hover:text-white transition-colors">GPT-5.2</button>
                        </div>
                    </div>
                    <div id="us-macro-ai-analysis" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">ë¶„ì„
                        ë¡œë”© ì¤‘...</div>
                </div>
            </section>
        </div>
        <!-- Weekly Economic Calendar Tab Content -->
        <div id="content-economic-calendar" class="hidden p-4 space-y-6">
            <h2 class="text-xl font-bold text-gray-200 mb-4">Economic Calendar</h2>
            <div class="mb-4 bg-[#1a1a1a] border border-[#2a2a2a] rounded p-4 max-w-2xl">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <h3 class="text-sm font-bold text-gray-300">ğŸ“… Weekly Economic Calendar</h3>
                        <span id="us-calendar-range" class="text-xs text-gray-500"></span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="expandAllCalendarEvents()"
                            class="px-2 py-1 text-[10px] bg-gray-800 hover:bg-gray-700 text-gray-300 rounded transition-colors">ğŸ”½
                            Expand All</button>
                        <button onclick="collapseAllCalendarEvents()"
                            class="px-2 py-1 text-[10px] bg-gray-800 hover:bg-gray-700 text-gray-300 rounded transition-colors">ğŸ”¼
                            Collapse All</button>
                    </div>
                </div>
                <div id="us-calendar-events" class="space-y-2">
                    <div class="text-center text-xs text-gray-500">Loading calendar...</div>
                </div>
            </div>
            <div class="text-gray-500 text-sm">Future performance charts will be displayed here.</div>
        </div>
    </main>

    <!-- INSERT_JS_HERE -->
    <script>
        // --- Global Variables ---
        let priceUpdateInterval;
        let currentChartTicker = null;
        let selectedDate = null;

        // --- Market Tab Switching ---
        function switchMarketTab(tabElement, marketName) {
            // Update header title
            document.getElementById('main-header-title').textContent = marketName;

            // Update active tab styling
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            tabElement.classList.add('active');

            // Toggle content visibility
            const krContent = document.getElementById('content-kr-market');
            const usContent = document.getElementById('content-us-market');
            const calcContent = document.getElementById('content-economic-calendar');

            // Hide all first
            krContent.classList.add('hidden');
            usContent.classList.add('hidden');
            if (calcContent) calcContent.classList.add('hidden');

            if (marketName.includes('KR')) {
                krContent.classList.remove('hidden');
            } else if (marketName.includes('US')) {
                usContent.classList.remove('hidden');
                updateUSMarketDashboard();
            } else if (marketName.includes('Calendar')) {
                if (calcContent) calcContent.classList.remove('hidden');
                updateUSMarketDashboard();
            }
        }


        // --- Language Toggle ---
        let currentLang = localStorage.getItem('dashboardLang') || 'ko';

        // Translation dictionary
        const i18n = {
            'us-market-indices': { ko: 'ğŸ‡ºğŸ‡¸ US Market Indices', en: 'ğŸ‡ºğŸ‡¸ US Market Indices' },
            'realtime-data': { ko: 'Real-time Data', en: 'Real-time Data' },
            'final-top10': { ko: 'ğŸ“Š Final Top 10 - Smart Money Picks', en: 'ğŸ“Š Final Top 10 - Smart Money Picks' },
            'sector': { ko: 'Sector', en: 'Sector' },
            'score': { ko: 'Score', en: 'Score' },
            'ai-rec': { ko: 'AI ì¶”ì²œ', en: 'AI Rec' },
            'rec-price': { ko: 'ì¶”ì²œê°€', en: 'Rec Price' },
            'current-price': { ko: 'í˜„ì¬ê°€', en: 'Current' },
            'change': { ko: 'ë³€ë™', en: 'Change' },
            'target-upside': { ko: 'ëª©í‘œ Upside', en: 'Target Upside' },
            'market-map': { ko: 'Market Map (Sector & Stocks)', en: 'Market Map (Sector & Stocks)' },
            'ai-analysis': { ko: 'ğŸ¤– AI íˆ¬ì ë¶„ì„', en: 'ğŸ¤– AI Investment Analysis' },
            'etf-flows': { ko: 'ğŸ’° ETF Fund Flows - ìê¸ˆ íë¦„', en: 'ğŸ’° ETF Fund Flows' },
            'top-inflows': { ko: 'ğŸ“ˆ Top Inflows', en: 'ğŸ“ˆ Top Inflows' },
            'top-outflows': { ko: 'ğŸ“‰ Top Outflows', en: 'ğŸ“‰ Top Outflows' },
            'options-flow': { ko: 'Options Flow - ê¸°ê´€ í¬ì§€ì…˜', en: 'Options Flow - Institutional Positions' },
            'macro-analysis': { ko: 'ğŸŒ Macro Analysis - AI ì˜ˆì¸¡', en: 'ğŸŒ Macro Analysis - AI Predictions' },
            'gemini-macro': { ko: 'Gemini 3.0 ë§¤í¬ë¡œ ë¶„ì„', en: 'Gemini 3.0 Macro Analysis' },
            'gpt-macro': { ko: 'GPT-5.2 ë§¤í¬ë¡œ ë¶„ì„', en: 'GPT-5.2 Macro Analysis' },
            'loading': { ko: 'ë¶„ì„ ë¡œë”© ì¤‘...', en: 'Loading analysis...' },
            'loading-options': { ko: 'Loading options...', en: 'Loading options...' },
            'loading-market-map': { ko: 'Loading Market Map...', en: 'Loading Market Map...' }
        };

        function translateUI() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (i18n[key]) {
                    el.textContent = i18n[key][currentLang] || i18n[key]['en'];
                }
            });
        }

        // Initialize language toggle UI
        document.getElementById('lang-toggle')?.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const lang = e.target.dataset.lang;
                if (lang !== currentLang) {
                    currentLang = lang;
                    localStorage.setItem('dashboardLang', lang);

                    // Update button styles
                    document.querySelectorAll('#lang-toggle button').forEach(btn => {
                        if (btn.dataset.lang === lang) {
                            btn.className = 'px-2 py-0.5 text-xs rounded-full bg-blue-600 text-white transition-colors';
                        } else {
                            btn.className = 'px-2 py-0.5 text-xs rounded-full text-gray-400 hover:text-white transition-colors';
                        }
                    });

                    // Translate UI text
                    translateUI();

                    // Reload macro analysis with new language
                    reloadMacroAnalysis();
                }
            }
        });

        // --- Model Toggle (Gemini/GPT) ---
        let currentModel = localStorage.getItem('dashboardModel') || 'gemini';

        // Initialize model toggle UI
        document.getElementById('model-toggle')?.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const model = e.target.dataset.model;
                if (model && model !== currentModel) {
                    currentModel = model;
                    localStorage.setItem('dashboardModel', model);

                    // Update button styles
                    document.querySelectorAll('#model-toggle button').forEach(btn => {
                        if (btn.dataset.model === model) {
                            btn.className = 'px-2 py-0.5 text-xs rounded-full bg-purple-600 text-white transition-colors';
                        } else {
                            btn.className = 'px-2 py-0.5 text-xs rounded-full text-gray-400 hover:text-white transition-colors';
                        }
                    });

                    // Update model label
                    const labelEl = document.getElementById('macro-model-label');
                    if (labelEl) {
                        if (model === 'gpt') {
                            labelEl.textContent = i18n['gpt-macro'][currentLang] || 'GPT-5.2 Macro Analysis';
                            labelEl.dataset.i18n = 'gpt-macro';
                        } else {
                            labelEl.textContent = i18n['gemini-macro'][currentLang] || 'Gemini 3.0 Macro Analysis';
                            labelEl.dataset.i18n = 'gemini-macro';
                        }
                    }

                    // Reload macro analysis with new model
                    reloadMacroAnalysis();
                }
            }
        });

        // Set initial button state based on saved language and model
        document.addEventListener('DOMContentLoaded', () => {
            // Language toggle
            document.querySelectorAll('#lang-toggle button').forEach(btn => {
                if (btn.dataset.lang === currentLang) {
                    btn.className = 'px-2 py-0.5 text-xs rounded-full bg-blue-600 text-white transition-colors';
                } else {
                    btn.className = 'px-2 py-0.5 text-xs rounded-full text-gray-400 hover:text-white transition-colors';
                }
            });

            // Model toggle
            document.querySelectorAll('#model-toggle button').forEach(btn => {
                if (btn.dataset.model === currentModel) {
                    btn.className = 'px-2 py-0.5 text-xs rounded-full bg-purple-600 text-white transition-colors';
                } else {
                    btn.className = 'px-2 py-0.5 text-xs rounded-full text-gray-400 hover:text-white transition-colors';
                }
            });

            // Update model label based on saved preference
            const labelEl = document.getElementById('macro-model-label');
            if (labelEl && currentModel === 'gpt') {
                labelEl.textContent = i18n['gpt-macro'][currentLang] || 'GPT-5.2 Macro Analysis';
                labelEl.dataset.i18n = 'gpt-macro';
            }

            // Apply initial translation
            translateUI();
        });

        async function reloadMacroAnalysis() {
            try {
                const macroRes = await fetch(`/api/us/macro-analysis?lang=${currentLang}&model=${currentModel}`);
                const macroData = await macroRes.json();
                if (macroData.macro_indicators) {
                    renderUSMacroAnalysis(macroData);
                }
            } catch (e) {
                console.log('Failed to reload macro analysis');
            }

            // Reload AI summary for current stock if one is selected
            if (currentChartPick) {
                loadUSAISummary(currentChartPick.ticker);
            }
        }

        // Auto-refresh Macro Analysis every 10 minutes (600000 ms)
        setInterval(() => {
            console.log('ğŸ”„ Auto-refreshing Macro Analysis...');
            reloadMacroAnalysis();
        }, 600000);  // 10 minutes

        // --- US Market Dashboard ---
        async function updateUSMarketDashboard() {
            try {
                if (typeof logDebug === 'function') logDebug("Fetching dashboard data...");

                // Fetch all US data in parallel
                const [portfolioRes, smartMoneyRes, etfFlowsRes, historyDatesRes] = await Promise.all([
                    fetch('/api/us/portfolio'),
                    fetch('/api/us/smart-money'),
                    fetch('/api/us/etf-flows'),
                    fetch('/api/us/history-dates')
                ]);

                if (typeof logDebug === 'function') logDebug("Fetch completed. Parsing JSON...");

                // Parse with individual error handling (though Promise.all ensures responses exist, JSON parse might fail)
                const portfolioData = await portfolioRes.json();
                const smartMoneyData = await smartMoneyRes.json();
                const etfFlowsData = await etfFlowsRes.json();
                const historyDatesData = await historyDatesRes.json();

                if (typeof logDebug === 'function') logDebug("JSON Parsed. Rendering components...");

                // Render Market Indices
                try {
                    if (portfolioData.market_indices) {
                        renderUSMarketIndices(portfolioData.market_indices);
                        if (typeof logDebug === 'function') logDebug("Indices rendered.");
                    }
                } catch (e) { console.error("Indices error", e); if (typeof logDebug === 'function') logDebug(`Indices Error: ${e.message}`); }

                // Populate history date selector
                try {
                    if (historyDatesData.dates) {
                        populateUSHistoryDates(historyDatesData.dates);
                    }
                } catch (e) { console.error("History Dates error", e); }

                // Render Smart Money Picks
                try {
                    if (smartMoneyData.top_picks) {
                        if (typeof logDebug === 'function') logDebug(`Rendering ${smartMoneyData.top_picks.length} picks...`);
                        renderUSSmartMoneyPicks(smartMoneyData);
                        if (typeof logDebug === 'function') logDebug("Picks rendered.");
                    } else if (smartMoneyData.top_picks === undefined) {
                        // Likely empty list from fallback
                        renderUSSmartMoneyPicks({ top_picks: [], summary: {} });
                        if (typeof logDebug === 'function') logDebug("Empty picks rendered.");
                    }
                } catch (e) { console.error("Smart Money error", e); if (typeof logDebug === 'function') logDebug(`Picks Error: ${e.message}`); }

                // Render ETF Flows
                try {
                    if (etfFlowsData.top_inflows) {
                        renderUSETFFlows(etfFlowsData);
                        if (typeof logDebug === 'function') logDebug("ETF Flows rendered.");
                    }
                } catch (e) { console.error("ETF error", e); if (typeof logDebug === 'function') logDebug(`ETF Error: ${e.message}`); }

                // Fetch and render Macro Analysis
                try {
                    const macroRes = await fetch('/api/us/macro-analysis');
                    const macroData = await macroRes.json();
                    if (macroData.macro_indicators) {
                        renderUSMacroAnalysis(macroData);
                    }
                } catch (e) {
                    console.log('Macro analysis not available');
                }

                // Fetch and render Sector Heatmap
                try {
                    const sectorRes = await fetch('/api/us/sector-heatmap');
                    const sectorData = await sectorRes.json();
                    if (sectorData.series) {
                        renderUSSectorHeatmap(sectorData);
                    }
                } catch (e) {
                    console.log('Sector heatmap not available');
                }

                // Fetch and render Options Flow
                try {
                    const optionsRes = await fetch('/api/us/options-flow');
                    const optionsData = await optionsRes.json();
                    if (optionsData.options_flow) {
                        renderUSOptionsFlow(optionsData);
                    }
                } catch (e) {
                    console.log('Options flow not available');
                }

                // Fetch and render Weekly Calendar
                try {
                    const calendarRes = await fetch('/api/us/calendar');
                    const calendarData = await calendarRes.json();
                    renderUSCalendar(calendarData);
                } catch (e) {
                    console.log('Calendar not available');
                }

                if (typeof logDebug === 'function') logDebug("Dashboard update complete.");

            } catch (e) {
                console.error("Error updating US dashboard:", e);
                if (typeof logDebug === 'function') logDebug(`Critical Dashboard Error: ${e.message}`);
            }
        }

        function renderUSOptionsFlow(data) {
            const container = document.getElementById('us-options-flow');
            const timestampEl = document.getElementById('us-options-timestamp');

            if (!container) return;
            container.innerHTML = '';

            // Update timestamp
            if (timestampEl && data.timestamp) {
                const date = new Date(data.timestamp);
                timestampEl.textContent = `ğŸ“… ${date.toLocaleDateString('ko-KR')}`;
            }

            // Render top 10 stocks
            const stocks = data.options_flow.slice(0, 10);

            stocks.forEach(stock => {
                const signal = stock.signal;
                const metrics = stock.metrics;
                const unusual = stock.unusual_activity;

                // Determine background color based on sentiment
                let bgClass, borderClass;
                if (signal.sentiment_score >= 70) {
                    bgClass = 'bg-green-900/30';
                    borderClass = 'border-green-600/50';
                } else if (signal.sentiment_score <= 30) {
                    bgClass = 'bg-red-900/30';
                    borderClass = 'border-red-600/50';
                } else {
                    bgClass = 'bg-yellow-900/30';
                    borderClass = 'border-yellow-600/50';
                }

                const hasUnusual = unusual.unusual_call_count > 0 || unusual.unusual_put_count > 0;

                const div = document.createElement('div');
                div.className = `${bgClass} border ${borderClass} rounded-lg p-3 cursor-pointer hover:opacity-80 transition-opacity`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-bold text-white">${stock.ticker}</span>
                        <span class="text-xs text-gray-400">$${stock.current_price}</span>
                    </div>
                    <div class="text-xs mb-1">${signal.sentiment}</div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>P/C: ${metrics.pc_volume_ratio.toFixed(2)}</span>
                        <span>IV: ${metrics.call_iv.toFixed(0)}%</span>
                    </div>
                    ${hasUnusual ? `<div class="text-xs text-orange-400 mt-1">âš¡ ${unusual.unusual_call_count + unusual.unusual_put_count} unusual</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        function renderUSMacroAnalysis(data) {
            const indicatorsEl = document.getElementById('us-macro-indicators');
            const analysisEl = document.getElementById('us-macro-ai-analysis');
            const timestampEl = document.getElementById('us-macro-timestamp');

            // Render timestamp
            if (timestampEl && data.timestamp) {
                const date = new Date(data.timestamp);
                timestampEl.textContent = `ğŸ“… ${date.toLocaleDateString('ko-KR')} ${date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}`;
            }

            // Render indicators grid
            if (indicatorsEl && data.macro_indicators) {
                indicatorsEl.innerHTML = '';
                const indicators = data.macro_indicators;

                // Define important indicators to highlight
                const volatilityIndicators = ['VIX', 'SKEW', 'FearGreed'];
                const cryptoIndicators = ['BTC', 'ETH'];
                const yieldIndicators = ['YieldSpread', '2Y_Yield', '10Y_Yield'];

                for (const [name, values] of Object.entries(indicators)) {
                    const change = values.change_1d || 0;
                    const changeClass = change >= 0 ? 'text-green-400' : 'text-red-400';
                    const arrow = change >= 0 ? 'â–²' : 'â–¼';

                    // Special styling for different categories
                    let boxClass = 'bg-[#1a1a1a] rounded p-2 text-center border border-[#2a2a2a]';
                    let labelClass = 'text-xs text-gray-500';

                    if (volatilityIndicators.includes(name)) {
                        // Purple glow for volatility
                        boxClass = 'bg-purple-900/30 rounded p-2 text-center border border-purple-600/50 shadow-lg shadow-purple-500/20';
                        labelClass = 'text-xs text-purple-300 font-bold';
                    } else if (cryptoIndicators.includes(name)) {
                        // Orange glow for crypto
                        boxClass = 'bg-orange-900/30 rounded p-2 text-center border border-orange-600/50 shadow-lg shadow-orange-500/20';
                        labelClass = 'text-xs text-orange-300 font-bold';
                    } else if (yieldIndicators.includes(name)) {
                        // Blue glow for yields
                        boxClass = 'bg-blue-900/30 rounded p-2 text-center border border-blue-600/50 shadow-lg shadow-blue-500/20';
                        labelClass = 'text-xs text-blue-300 font-bold';
                    }

                    const div = document.createElement('div');
                    div.className = boxClass;
                    div.innerHTML = `
                        <div class="${labelClass}">${name}</div>
                        <div class="text-sm font-bold text-white">${values.current ?? values.value ?? '-'}</div>
                        <div class="${changeClass} text-xs">${arrow} ${Math.abs(change).toFixed(2)}%</div>
                    `;
                    indicatorsEl.appendChild(div);
                }
            }

            // Render AI analysis
            if (analysisEl && data.ai_analysis) {
                // Convert markdown-like formatting
                let html = data.ai_analysis
                    .replace(/### (.*)/g, '<h3 class="text-purple-300 font-bold mt-3 mb-1">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                    .replace(/ğŸš€/g, '<span class="text-green-400">ğŸš€</span>')
                    .replace(/âš ï¸/g, '<span class="text-yellow-400">âš ï¸</span>')
                    .replace(/\n/g, '<br>');
                analysisEl.innerHTML = html;
            }
        }

        function renderUSCalendar(data) {
            const container = document.getElementById('us-calendar-events');
            const rangeEl = document.getElementById('us-calendar-range');

            if (!container) return;

            // Set date range
            if (rangeEl && data.week_start && data.week_end) {
                rangeEl.textContent = `${data.week_start} ~ ${data.week_end}`;
            }

            container.innerHTML = '';

            if (!data.events || data.events.length === 0) {
                container.innerHTML = '<div class="text-center text-xs text-gray-500 py-2">No major events schedule for this week.</div>';
                return;
            }

            // Render events
            data.events.forEach(event => {
                let icon = 'ğŸ“…';
                let colorClass = 'text-gray-300';
                let bgClass = 'bg-[#2a2a2a]';

                if (event.type === 'Earnings') {
                    icon = 'ğŸ¢';
                    colorClass = 'text-blue-300';
                    bgClass = 'bg-blue-900/20 border border-blue-800/30';
                } else if (event.impact === 'High') {
                    icon = 'ğŸ”¥';
                    colorClass = 'text-red-300';
                    bgClass = 'bg-red-900/20 border border-red-800/30';
                }

                const eventId = `cal-evt-${Math.random().toString(36).substr(2, 9)}`;

                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <div class="flex items-center justify-between p-2 rounded text-xs ${bgClass} cursor-pointer hover:bg-opacity-80 transition-all" onclick="toggleCalendarDetails('${eventId}')">
                        <div class="flex items-center gap-2">
                            <span>${icon}</span>
                            <span class="font-medium ${colorClass}">${event.event}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">${event.date}</span>
                            <i class="fas fa-chevron-down text-[10px] text-gray-500 transition-transform" id="arrow-${eventId}"></i>
                        </div>
                    </div>
                    <div id="${eventId}" class="hidden bg-[#222] border-x border-b border-[#2a2a2a] rounded-b p-3 text-xs text-gray-400 space-y-2">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                            <span class="font-semibold text-gray-300">Detailed Info</span>
                            <span class="bg-gray-800 px-2 py-0.5 rounded text-[10px]">Impact: ${event.impact}</span>
                        </div>
                        <div class="leading-relaxed whitespace-pre-wrap">
                            ${event.description ? event.description.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-200">$1</strong>').replace(/\\n/g, '<br>') : '<span class="text-gray-500">ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>'}
                        </div>
                        ${event.type === 'Earnings' ? `
                        <div class="mt-2 flex gap-2">
                            <button class="flex-1 bg-blue-900/30 hover:bg-blue-900/50 text-blue-300 py-1 rounded transition-colors text-center" onclick="loadUSAISummary('${event.event.split(' ')[0]}'); event.stopPropagation();">
                                ğŸ¤– AI Analysis
                            </button>
                            <button class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 py-1 rounded transition-colors text-center" onclick="window.open('https://finance.yahoo.com/quote/${event.event.split(' ')[0]}', '_blank'); event.stopPropagation();">
                                ğŸ“Š Yahoo Finance
                            </button>
                        </div>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleCalendarDetails(id) {
            const el = document.getElementById(id);
            const arrow = document.getElementById(`arrow-${id}`);
            if (el) {
                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    el.classList.add('hidden');
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        }

        function expandAllCalendarEvents() {
            document.querySelectorAll('[id^="cal-evt-"]').forEach(el => {
                el.classList.remove('hidden');
            });
            document.querySelectorAll('[id^="arrow-cal-evt-"]').forEach(arrow => {
                arrow.style.transform = 'rotate(180deg)';
            });
        }

        function collapseAllCalendarEvents() {
            document.querySelectorAll('[id^="cal-evt-"]').forEach(el => {
                el.classList.add('hidden');
            });
            document.querySelectorAll('[id^="arrow-cal-evt-"]').forEach(arrow => {
                arrow.style.transform = 'rotate(0deg)';
            });
        }

        function renderUSSectorHeatmap(data) {
            const container = document.getElementById('us-sector-heatmap');
            if (!container) return;

            // Should verify data structure
            if (!data.series) {
                // Fallback if old data format
                container.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-gray-500">Data updating... please refresh later</div>';
                return;
            }

            // Update date if available
            const dateEl = document.getElementById('us-heatmap-date');
            if (dateEl && data.data_date) {
                dateEl.textContent = `ê¸°ì¤€: ${data.data_date}`;
            }

            // Clear loading
            container.innerHTML = '';

            // Map colors properly
            const seriesData = data.series.map(sector => ({
                name: sector.name,
                data: sector.data.map(stock => ({
                    x: stock.x,
                    y: stock.y,
                    fillColor: stock.color, // Use color from backend
                    // Add meta for tooltip
                    meta: {
                        change: stock.change,
                        price: stock.price
                    }
                }))
            }));

            const options = {
                series: seriesData,
                chart: {
                    type: 'treemap',
                    height: 300,
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif',
                    background: 'transparent'
                },
                legend: { show: false },
                colors: ['#3b82f6'], // Default color, will be overridden by fillColor
                plotOptions: {
                    treemap: {
                        distributed: true,
                        enableShades: false,
                        useFillColorAsStroke: true
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '10px',
                        fontWeight: 'bold',
                        colors: ['#ffffff']
                    },
                    formatter: function (text, op) {
                        // Safely get change value
                        try {
                            const dataPoint = op.w.config.series[op.seriesIndex].data[op.dataPointIndex];
                            const change = dataPoint?.meta?.change;
                            if (change !== undefined) {
                                return [text, (change >= 0 ? '+' : '') + change.toFixed(1) + '%'];
                            }
                        } catch (e) { }
                        return text;
                    },
                    offsetY: -4
                },
                tooltip: {
                    theme: 'dark',
                    y: {
                        formatter: function (value, op) {
                            // Find the original data using dataPointIndex
                            const dataPoint = op.w.config.series[op.seriesIndex].data[op.dataPointIndex];
                            const change = dataPoint.meta.change;
                            const price = dataPoint.meta.price;
                            return `$${price} (${change > 0 ? '+' : ''}${change}%)`;
                        }
                    }
                },
                stroke: {
                    width: 1,
                    colors: ['#1a1a1a']
                }
            };

            const chart = new ApexCharts(container, options);
            chart.render();
        }

        function renderUSSmartMoneyPicks(data) {
            const table = document.getElementById('us-smart-money-table');
            const summary = document.getElementById('us-smart-money-summary');

            if (!table) return;
            table.innerHTML = '';

            // Robust check for data
            if (!data || !data.top_picks || !Array.isArray(data.top_picks)) {
                console.warn('Invalid smart money data:', data);
                table.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            if (data.top_picks.length === 0) {
                table.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">ë¶„ì„ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ì„œë²„/íŒŒì¼ í™•ì¸ í•„ìš”)</td></tr>';
                return;
            }

            // Store picks data for later use
            window.usSmartMoneyPicks = data.top_picks;

            // Update summary with analysis date
            if (summary) {
                const analysisDate = data.analysis_date || '';
                const avgScore = data.summary?.avg_score || 0;
                summary.innerHTML = `<span class="text-purple-400">ğŸ“… ë¶„ì„ì¼: ${analysisDate}</span> | í‰ê· : ${avgScore}ì `;

                // Call updateDateHeaders function
                if (typeof updateDateHeaders === 'function') {
                    updateDateHeaders(analysisDate);
                }

                // Update last update time
                const lastUpdateTimeEl = document.getElementById('last-update-time');
                if (lastUpdateTimeEl) {
                    const now = new Date();
                    const updateStr = now.toLocaleString('ko-KR', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    lastUpdateTimeEl.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${updateStr}`;
                }
            }

            // Render rows
            data.top_picks.forEach((pick, idx) => {
                const gradeClass = pick.grade?.includes('Aê¸‰') ? 'text-yellow-400' :
                    pick.grade?.includes('Bê¸‰') ? 'text-green-400' : 'text-gray-400';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-[#2a2a2a] hover:bg-[#252525] cursor-pointer';
                tr.setAttribute('data-ticker', pick.ticker);
                tr.setAttribute('data-idx', idx);

                // Performance change color
                const change = pick.change_since_rec || 0;
                const changeClass = change >= 0 ? 'text-green-400' : 'text-red-400';
                const changePrefix = change >= 0 ? '+' : '';

                // Score display
                const score = pick.final_score || pick.composite_score || 0;

                // AI recommendation mapping
                let aiRec = pick.ai_recommendation || 'ë¶„ì„ ì¤‘';
                let recEmoji = 'ğŸ“Š';

                // Map English to Korean/Emoji
                if (aiRec.toLowerCase().includes('strong buy') || aiRec.includes('ì ê·¹')) {
                    aiRec = 'ì ê·¹ ë§¤ìˆ˜';
                    recEmoji = 'ğŸ”¥';
                } else if (aiRec.toLowerCase().includes('buy') || aiRec.includes('ë§¤ìˆ˜')) {
                    aiRec = 'ë§¤ìˆ˜';
                    recEmoji = 'ğŸ“ˆ';
                } else if (aiRec.toLowerCase().includes('hold') || aiRec.includes('ë³´ìœ ')) {
                    aiRec = 'ì¤‘ë¦½';
                    recEmoji = 'âœ‹';
                }

                // Prices
                const priceAtRec = pick.price_at_rec || pick.price_at_analysis || pick.current_price || 0;
                const currentPrice = pick.current_price || priceAtRec;

                // Calculate target upside in frontend
                const targetPrice = pick.target_price || 0;
                let targetUpside = null;
                let upsideDisplay = 'N/A';
                let upsideClass = 'text-gray-400';

                if (targetPrice > 0 && currentPrice > 0) {
                    targetUpside = ((targetPrice / currentPrice) - 1) * 100;
                    upsideDisplay = (targetUpside >= 0 ? '+' : '') + targetUpside.toFixed(1) + '%';
                    upsideClass = targetUpside > 0 ? 'text-green-400' : 'text-red-400';
                }

                tr.innerHTML = `
                    <td class="p-2 text-gray-500">${pick.rank || idx + 1}</td>
                    <td class="p-2"><span class="text-gray-400 text-xs">${pick.name || ''}</span> <span class="text-white font-bold">(${pick.ticker})</span></td>
                    <td class="p-2 text-center"><span class="text-xs px-1.5 py-0.5 rounded bg-purple-900/50 text-purple-300">${pick.sector || '-'}</span></td>
                    <td class="p-2 text-center text-blue-400 font-bold">${score}</td>
                    <td class="p-2 text-center text-xs"><span class="text-yellow-400">${recEmoji} ${aiRec}</span></td>
                    <td class="p-2 text-center text-gray-300">$${priceAtRec.toFixed(2)}</td>
                    <td class="p-2 text-center text-white font-bold">$${currentPrice.toFixed(2)}</td>
                    <td class="p-2 text-center ${changeClass} font-bold">${changePrefix}${change.toFixed(2)}%</td>
                    <td class="p-2 text-center ${upsideClass} font-bold">${upsideDisplay}</td>
                `;

                // Add click handler
                tr.addEventListener('click', () => {
                    if (typeof loadUSStockChart === 'function') {
                        loadUSStockChart(pick, idx);
                    }
                });
                table.appendChild(tr);
            });

            // Auto-load first stock
            if (data.top_picks.length > 0) {
                if (typeof loadUSStockChart === 'function') {
                    loadUSStockChart(data.top_picks[0], 0);
                }
            }
        }

        function populateUSHistoryDates(dates) {
            const select = document.getElementById('us-history-date-select');
            if (!select) return;

            // Keep first option
            select.innerHTML = '<option value="">ğŸ“… ìµœì‹  ë¶„ì„</option>';

            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                select.appendChild(option);
            });
        }

        async function loadUSHistoryByDate(date) {
            if (!date) {
                // Load current/latest data
                updateUSMarketDashboard();
                return;
            }

            try {
                const response = await fetch(`/api/us/history/${date}`);
                const data = await response.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Update summary with performance
                const summary = document.getElementById('us-smart-money-summary');
                if (summary && data.summary) {
                    const perf = data.summary.avg_performance || 0;
                    const perfClass = perf >= 0 ? 'text-green-400' : 'text-red-400';
                    const perfPrefix = perf >= 0 ? '+' : '';
                    summary.innerHTML = `<span class="text-purple-400">ğŸ“… ${date}</span> | <span class="${perfClass}">í‰ê·  ${perfPrefix}${perf}%</span>`;
                }

                // Render the historical picks
                renderUSSmartMoneyPicks(data);

            } catch (e) {
                console.error('Error loading history:', e);
            }
        }

        // US Stock Chart instance
        let usStockChart = null;
        let currentChartPick = null;
        let currentChartPeriod = '1y';

        // Period button click handlers
        document.getElementById('us-chart-period-btns')?.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const period = e.target.dataset.period;
                currentChartPeriod = period;

                // Update button styles
                document.querySelectorAll('#us-chart-period-btns button').forEach(btn => {
                    btn.className = 'px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 hover:bg-blue-600 hover:text-white transition-colors';
                });
                e.target.className = 'px-2 py-1 text-xs rounded bg-blue-600 text-white';

                // Reload chart with new period
                if (currentChartPick) {
                    loadUSStockChart(currentChartPick, -1, period);
                }
            }
        });

        async function loadUSStockChart(pick, idx, period = null) {
            const chartContainer = document.getElementById('us-stock-chart');
            const tickerEl = document.getElementById('us-chart-ticker');
            const infoEl = document.getElementById('us-chart-info');
            const gradeEl = document.getElementById('us-chart-grade');

            if (!chartContainer) return;

            // Save current pick for period switching
            currentChartPick = pick;
            const usePeriod = period || currentChartPeriod;

            // Update header
            tickerEl.textContent = pick.ticker;
            const score = pick.final_score || pick.composite_score || 0;
            infoEl.textContent = `${pick.name || pick.ticker} | Score: ${score}/100`;

            const aiRec = pick.ai_recommendation || 'ë¶„ì„ ì¤‘';
            let displayRec = aiRec;
            let bgClass = 'bg-gray-600';

            if (aiRec.toLowerCase().includes('strong buy') || aiRec.includes('ì ê·¹')) {
                displayRec = 'ì ê·¹ ë§¤ìˆ˜';
                bgClass = 'bg-yellow-600';
            } else if (aiRec.toLowerCase().includes('buy') || aiRec.includes('ë§¤ìˆ˜')) {
                displayRec = 'ë§¤ìˆ˜';
                bgClass = 'bg-green-600';
            }

            gradeEl.textContent = displayRec;
            gradeEl.className = `px-3 py-1 rounded text-sm font-bold ${bgClass} text-white`;

            // Update details panel
            updateUSStockDetails(pick);

            // Highlight selected row
            if (idx >= 0) {
                document.querySelectorAll('#us-smart-money-table tr').forEach(tr => {
                    tr.classList.remove('bg-[#2a2a2a]');
                });
                document.querySelector(`#us-smart-money-table tr[data-idx="${idx}"]`)?.classList.add('bg-[#2a2a2a]');
            }

            // Fetch and render chart
            try {
                // Force container height
                chartContainer.style.height = '300px';
                chartContainer.style.position = 'relative';
                chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> <span class="ml-2">Loading Chart...</span></div>';

                // Wait a bit to ensure library load
                if (typeof LightweightCharts === 'undefined') {
                    await new Promise(r => setTimeout(r, 1000)); // wait 1s
                }

                // Ensure Library is loaded
                if (typeof LightweightCharts === 'undefined') {
                    chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-500 flex-col"><i class="fas fa-exclamation-triangle mb-2"></i><span>Chart Library Not Loaded</span><span class="text-xs text-gray-400 mt-1">Check internet connection or CDN</span></div>';
                    return;
                }

                const response = await fetch(`/api/us/stock-chart/${pick.ticker}?period=${usePeriod}`);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();

                if (data.error) {
                    chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">${data.error}</div>`;
                    return;
                }

                if (!data.candles || data.candles.length === 0) {
                    chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">No price data for ${pick.ticker}</div>`;
                    return;
                }

                // Clear container and create chart
                chartContainer.innerHTML = '';

                // Dispose previous chart if exists
                if (usStockChart) {
                    try {
                        usStockChart.remove();
                    } catch (e) { console.warn("Chart remove error", e); }
                    usStockChart = null;
                }

                // Double check container dimensions
                const containerWidth = chartContainer.clientWidth || chartContainer.parentElement.clientWidth || 600;
                const containerHeight = chartContainer.clientHeight || 300;

                usStockChart = LightweightCharts.createChart(chartContainer, {
                    width: containerWidth,
                    height: containerHeight,
                    layout: { background: { color: '#1a1a1a' }, textColor: '#999' },
                    grid: { vertLines: { color: '#2a2a2a' }, horzLines: { color: '#2a2a2a' } },
                    timeScale: {
                        borderColor: '#2a2a2a',
                        timeVisible: true,
                        rightOffset: 5,
                        fixLeftEdge: true,
                        fixRightEdge: true
                    },
                    rightPriceScale: { borderColor: '#2a2a2a' },
                    handleScroll: false,
                    handleScale: false
                });

                const candleSeries = usStockChart.addCandlestickSeries({
                    upColor: '#22c55e',
                    downColor: '#ef4444',
                    borderUpColor: '#22c55e',
                    borderDownColor: '#ef4444',
                    wickUpColor: '#22c55e',
                    wickDownColor: '#ef4444'
                });

                candleSeries.setData(data.candles);
                usStockChart.timeScale().fitContent();

                // Add ResizeObserver for responsiveness
                const resizeObserver = new ResizeObserver(entries => {
                    if (entries.length === 0 || entries[0].target !== chartContainer) { return; }
                    const newRect = entries[0].contentRect;
                    if (usStockChart) {
                        usStockChart.applyOptions({ width: newRect.width, height: newRect.height });
                    }
                });
                resizeObserver.observe(chartContainer);

                // Reset and reload indicators for new stock
                indicatorData = null;
                bbUpperSeries = null; bbMiddleSeries = null; bbLowerSeries = null;
                srLines = [];

                // Hide sub-charts
                document.getElementById('us-rsi-chart')?.classList.add('hidden');
                document.getElementById('us-macd-chart')?.classList.add('hidden');
                if (rsiChart) { rsiChart.remove(); rsiChart = null; }
                if (macdChart) { macdChart.remove(); macdChart = null; }

                // If any indicator is active, reload data and re-render
                if (indicatorState.bb || indicatorState.sr || indicatorState.rsi || indicatorState.macd) {
                    loadTechnicalIndicators(pick.ticker, usePeriod).then(() => {
                        if (indicatorState.bb) renderBollingerBands();
                        if (indicatorState.sr) renderSupportResistance();
                        if (indicatorState.rsi) renderRSI();
                        if (indicatorState.macd) renderMACD();
                    });
                }

                // Load AI Summary
                loadUSAISummary(pick.ticker);

            } catch (e) {
                console.error('Error loading US stock chart:', e);
                chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">Error: ${e.message}</div>`;
            }
        }

        // --- Technical Indicators ---
        let indicatorState = { bb: false, sr: false, rsi: false, macd: false };
        let indicatorData = null;
        let bbUpperSeries = null, bbMiddleSeries = null, bbLowerSeries = null;
        let srLines = [];
        let rsiChart = null, rsiSeries = null;
        let macdChart = null, macdLineSeries = null, macdSignalSeries = null, macdHistSeries = null;

        async function loadTechnicalIndicators(ticker, period = '1y') {
            try {
                const response = await fetch(`/api/us/technical-indicators/${ticker}?period=${period}`);
                indicatorData = await response.json();
                console.log('Loaded indicators for', ticker, indicatorData);
            } catch (e) {
                console.error('Error loading technical indicators:', e);
                indicatorData = null;
            }
        }

        function toggleIndicator(type) {
            indicatorState[type] = !indicatorState[type];
            const btn = document.getElementById(`toggle-${type}`);

            if (indicatorState[type]) {
                btn.classList.add('bg-purple-600', 'text-white');
                btn.classList.remove('bg-gray-700', 'text-gray-300');
            } else {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            }

            // Ensure indicator data is loaded
            if (!indicatorData && currentChartPick) {
                loadTechnicalIndicators(currentChartPick.ticker, currentChartPeriod).then(() => {
                    renderIndicator(type);
                });
            } else {
                renderIndicator(type);
            }
        }

        function renderIndicator(type) {
            if (!indicatorData || !usStockChart) return;

            if (type === 'bb') renderBollingerBands();
            else if (type === 'sr') renderSupportResistance();
            else if (type === 'rsi') renderRSI();
            else if (type === 'macd') renderMACD();
        }

        function renderBollingerBands() {
            // Remove existing BB series
            if (bbUpperSeries) { usStockChart.removeSeries(bbUpperSeries); bbUpperSeries = null; }
            if (bbMiddleSeries) { usStockChart.removeSeries(bbMiddleSeries); bbMiddleSeries = null; }
            if (bbLowerSeries) { usStockChart.removeSeries(bbLowerSeries); bbLowerSeries = null; }

            if (!indicatorState.bb || !indicatorData?.bollinger) return;

            bbUpperSeries = usStockChart.addLineSeries({ color: 'rgba(147, 51, 234, 0.5)', lineWidth: 1 });
            bbMiddleSeries = usStockChart.addLineSeries({ color: 'rgba(147, 51, 234, 0.8)', lineWidth: 1, lineStyle: 2 });
            bbLowerSeries = usStockChart.addLineSeries({ color: 'rgba(147, 51, 234, 0.5)', lineWidth: 1 });

            bbUpperSeries.setData(indicatorData.bollinger.upper);
            bbMiddleSeries.setData(indicatorData.bollinger.middle);
            bbLowerSeries.setData(indicatorData.bollinger.lower);
        }

        function renderSupportResistance() {
            // Remove existing S/R lines
            srLines.forEach(line => usStockChart.removeSeries(line));
            srLines = [];

            if (!indicatorState.sr || !indicatorData?.support_resistance) return;

            const sr = indicatorData.support_resistance;

            // Draw support lines (green)
            sr.support?.forEach(level => {
                const line = usStockChart.addLineSeries({
                    color: '#22c55e',
                    lineWidth: 1,
                    lineStyle: 2,
                    priceLineVisible: true,
                    lastValueVisible: true
                });
                // Create horizontal line data
                if (indicatorData.rsi?.length > 0) {
                    const times = indicatorData.rsi;
                    line.setData([
                        { time: times[0].time, value: level },
                        { time: times[times.length - 1].time, value: level }
                    ]);
                }
                srLines.push(line);
            });

            // Draw resistance lines (red)  
            sr.resistance?.forEach(level => {
                const line = usStockChart.addLineSeries({
                    color: '#ef4444',
                    lineWidth: 1,
                    lineStyle: 2,
                    priceLineVisible: true,
                    lastValueVisible: true
                });
                if (indicatorData.rsi?.length > 0) {
                    const times = indicatorData.rsi;
                    line.setData([
                        { time: times[0].time, value: level },
                        { time: times[times.length - 1].time, value: level }
                    ]);
                }
                srLines.push(line);
            });
        }

        function renderRSI() {
            const container = document.getElementById('us-rsi-chart');

            if (!indicatorState.rsi) {
                container.classList.add('hidden');
                if (rsiChart) { rsiChart.remove(); rsiChart = null; }
                return;
            }

            container.classList.remove('hidden');
            container.innerHTML = '';

            rsiChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 80,
                layout: { background: { color: '#1a1a1a' }, textColor: '#666' },
                grid: { vertLines: { color: '#2a2a2a' }, horzLines: { color: '#2a2a2a' } },
                timeScale: { visible: false },
                rightPriceScale: { borderColor: '#2a2a2a', scaleMargins: { top: 0.1, bottom: 0.1 } },
                handleScroll: false, handleScale: false
            });

            rsiSeries = rsiChart.addLineSeries({ color: '#22c55e', lineWidth: 1 });
            rsiSeries.setData(indicatorData.rsi || []);

            // Add overbought/oversold lines
            const ovLine = rsiChart.addLineSeries({ color: '#ef4444', lineWidth: 1, lineStyle: 2 });
            const osLine = rsiChart.addLineSeries({ color: '#22c55e', lineWidth: 1, lineStyle: 2 });

            if (indicatorData.rsi?.length > 0) {
                const times = indicatorData.rsi;
                ovLine.setData([{ time: times[0].time, value: 70 }, { time: times[times.length - 1].time, value: 70 }]);
                osLine.setData([{ time: times[0].time, value: 30 }, { time: times[times.length - 1].time, value: 30 }]);
            }

            rsiChart.timeScale().fitContent();
        }

        function renderMACD() {
            const container = document.getElementById('us-macd-chart');

            if (!indicatorState.macd) {
                container.classList.add('hidden');
                if (macdChart) { macdChart.remove(); macdChart = null; }
                return;
            }

            container.classList.remove('hidden');
            container.innerHTML = '';

            macdChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 80,
                layout: { background: { color: '#1a1a1a' }, textColor: '#666' },
                grid: { vertLines: { color: '#2a2a2a' }, horzLines: { color: '#2a2a2a' } },
                timeScale: { visible: false },
                rightPriceScale: { borderColor: '#2a2a2a' },
                handleScroll: false, handleScale: false
            });

            macdLineSeries = macdChart.addLineSeries({ color: '#3b82f6', lineWidth: 1 });
            macdSignalSeries = macdChart.addLineSeries({ color: '#f59e0b', lineWidth: 1 });
            macdHistSeries = macdChart.addHistogramSeries({
                color: '#22c55e',
                priceFormat: { type: 'volume' },
                priceScaleId: ''
            });
            macdChart.priceScale('').applyOptions({ scaleMargins: { top: 0.7, bottom: 0 } });

            macdLineSeries.setData(indicatorData.macd?.macd_line || []);
            macdSignalSeries.setData(indicatorData.macd?.signal_line || []);

            // Color histogram based on value
            const histData = (indicatorData.macd?.histogram || []).map(d => ({
                time: d.time,
                value: d.value,
                color: d.value >= 0 ? '#22c55e' : '#ef4444'
            }));
            macdHistSeries.setData(histData);

            macdChart.timeScale().fitContent();
        }

        async function loadUSAISummary(ticker) {
            const mainAnalysisEl = document.getElementById('ai-main-analysis');
            const keyPointsEl = document.getElementById('ai-key-points');
            const risksEl = document.getElementById('ai-risks');
            const recommendationEl = document.getElementById('ai-recommendation');
            const updatedEl = document.getElementById('us-ai-updated');

            if (!mainAnalysisEl) return;

            const loadingText = currentLang === 'en' ? 'Loading...' : 'ë¡œë”© ì¤‘...';
            mainAnalysisEl.innerHTML = `<span class="text-gray-500"><i class="fas fa-spinner fa-spin"></i> ${loadingText}</span>`;
            if (keyPointsEl) keyPointsEl.textContent = '-';
            if (risksEl) risksEl.textContent = '-';
            if (recommendationEl) recommendationEl.textContent = '-';

            try {
                const response = await fetch(`/api/us/ai-summary/${ticker}?lang=${currentLang}`);
                const data = await response.json();

                if (data.error) {
                    mainAnalysisEl.innerHTML = `<span class="text-gray-500">${data.error}</span>`;
                    return;
                }

                // Parse AI summary to extract different sections
                const summary = data.summary || '';

                // Extract sections using markers or split by newlines
                const lines = summary.split('\n').filter(line => line.trim());


                // Main analysis (first paragraph or summary)
                let mainText = '';
                let keyPoints = '';
                let risks = '';
                let recommendation = '';

                // Simple parsing - look for keywords
                lines.forEach((line, idx) => {
                    const lower = line.toLowerCase();
                    if (lower.includes('ì¶”ì²œ') || lower.includes('recommend')) {
                        recommendation = line.replace(/.*?[:ï¼š]/, '').trim();
                    } else if (lower.includes('ë¦¬ìŠ¤í¬') || lower.includes('risk') || lower.includes('ì£¼ì˜')) {
                        risks = line.replace(/.*?[:ï¼š]/, '').trim();
                    } else if (lower.includes('í¬ì¸íŠ¸') || lower.includes('ê°•ì ') || lower.includes('point')) {
                        keyPoints = line.replace(/.*?[:ï¼š]/, '').trim();
                    } else if (idx < 2 && !mainText) {
                        // First 1-2 lines as main analysis
                        mainText += line + ' ';
                    }
                });

                // Fallback: if sections not found, use full summary
                if (!mainText) mainText = summary;
                if (!keyPoints) keyPoints = 'ê¸°ê´€ ë§¤ìˆ˜ì„¸, ê¸°ìˆ ì  ëª¨ë©˜í…€ ê¸ì •ì ';
                if (!risks) risks = 'ì‹œì¥ ë³€ë™ì„± ì£¼ì˜';
                if (!recommendation) {
                    // Extract from data.recommendation if available
                    const rec = data.recommendation || data.ai_recommendation || 'ë¶„ì„ ì¤‘';
                    recommendation = rec;
                }

                // Update UI
                if (mainAnalysisEl) {
                    let htmlText = mainText
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                        .replace(/## (.*)/g, '<strong class="text-white">$1</strong>');
                    mainAnalysisEl.innerHTML = htmlText;
                }

                if (keyPointsEl) keyPointsEl.textContent = keyPoints;
                if (risksEl) risksEl.textContent = risks;
                if (recommendationEl) {
                    recommendationEl.textContent = recommendation;
                    // Color code recommendation
                    if (recommendation.includes('ì ê·¹') || recommendation.toLowerCase().includes('strong buy')) {
                        recommendationEl.className = 'text-sm font-semibold text-green-400';
                    } else if (recommendation.includes('ë§¤ìˆ˜') || recommendation.toLowerCase().includes('buy')) {
                        recommendationEl.className = 'text-sm font-semibold text-blue-400';
                    } else {
                        recommendationEl.className = 'text-sm font-semibold text-yellow-400';
                    }
                }

                if (updatedEl && data.updated) {
                    const date = new Date(data.updated);
                    updatedEl.textContent = `Updated: ${date.toLocaleDateString()}`;
                }
            } catch (e) {
                console.error('Error loading AI summary:', e);
                if (mainAnalysisEl) {
                    mainAnalysisEl.innerHTML = '<span class="text-gray-500">AI ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
                }
            }
        }
        function updateUSStockDetails(pick) {
            // Stock Details section was replaced with Sector Heatmap
            // No need to update individual stock details anymore
        }

        function renderUSETFFlows(data) {
            const inflowsContainer = document.getElementById('us-etf-inflows');
            const outflowsContainer = document.getElementById('us-etf-outflows');
            const sentimentEl = document.getElementById('us-etf-sentiment');

            // Update sentiment badge
            if (sentimentEl && data.market_sentiment_score) {
                const score = data.market_sentiment_score;
                let sentiment, bgColor;
                if (score >= 60) { sentiment = 'Bullish'; bgColor = 'bg-green-600'; }
                else if (score >= 50) { sentiment = 'Neutral'; bgColor = 'bg-gray-600'; }
                else { sentiment = 'Bearish'; bgColor = 'bg-red-600'; }
                sentimentEl.textContent = `${sentiment} (${score})`;
                sentimentEl.className = `text-xs px-2 py-1 rounded ${bgColor} text-white`;
            }

            // Render inflows
            if (inflowsContainer && data.top_inflows) {
                inflowsContainer.innerHTML = '';
                data.top_inflows.forEach(etf => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm';
                    div.innerHTML = `
                        <span class="text-white">${etf.ticker} <span class="text-gray-500 text-xs">${etf.name}</span></span>
                        <span class="text-green-400 font-bold">${etf.flow_score}</span>
                    `;
                    inflowsContainer.appendChild(div);
                });
            }

            // Render outflows
            if (outflowsContainer && data.top_outflows) {
                outflowsContainer.innerHTML = '';
                data.top_outflows.forEach(etf => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm';
                    div.innerHTML = `
                        <span class="text-white">${etf.ticker} <span class="text-gray-500 text-xs">${etf.name}</span></span>
                        <span class="text-red-400 font-bold">${etf.flow_score}</span>
                    `;
                    outflowsContainer.appendChild(div);
                });
            }

            // AI Analysis Button Handler
            const aiBtn = document.getElementById('us-etf-ai-btn');
            const aiContainer = document.getElementById('us-etf-ai-container');
            const aiContent = document.getElementById('us-etf-ai-content');

            if (data.ai_analysis && aiBtn && aiContainer && aiContent) {
                aiBtn.classList.remove('hidden');

                // Remove existing listeners to prevent duplicates
                const newBtn = aiBtn.cloneNode(true);
                aiBtn.parentNode.replaceChild(newBtn, aiBtn);

                newBtn.addEventListener('click', () => {
                    aiContainer.classList.toggle('hidden');
                    // Use textContent for safety, or innerHTML if we trust the source (we generated it)
                    // Since Gemini might generate bolding (**text**), we should ideally parse markdown.
                    // But for now, textContent is safer. Or simple replacement for bold.
                    aiContent.textContent = data.ai_analysis;
                });
            } else if (aiBtn) {
                aiBtn.classList.add('hidden');
            }
        }

        function renderUSMarketIndices(indices) {
            const container = document.getElementById('us-market-indices-container');
            if (!container) return;
            container.innerHTML = '';

            if (!indices || indices.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 text-sm">Loading market data...</div>';
                return;
            }

            indices.forEach(idx => {
                // US Color Standard: Green = Up, Red = Down
                const colorClass = idx.color === 'green' ? 'text-[#00E396]' : (idx.color === 'red' ? 'text-[#FF4560]' : 'text-gray-400');
                const sign = idx.change_pct > 0 ? '+' : '';

                const div = document.createElement('div');
                div.className = 'bg-[#1a1a1a] border border-[#2a2a2a] rounded p-3 flex flex-col items-center justify-center hover:bg-[#252525] transition-colors';
                div.innerHTML = `
                    <span class="text-xs text-gray-400 mb-1">${idx.name}</span>
                    <span class="text-lg font-bold text-white mb-1">${idx.price}</span>
                    <span class="text-xs font-medium ${colorClass}">${idx.change} (${sign}${idx.change_pct.toFixed(2)}%)</span>
                `;
                container.appendChild(div);
            });
        }


        if (updateIcon) {
            updateIcon.classList.add('fa-spin');
        }

        if (lastUpdateTimeEl) {
            lastUpdateTimeEl.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘... (ì˜ˆìƒ ì‹œê°„: 10-15ì´ˆ)';
        }

        try {
            // Parallel fetching for performance
            await Promise.all([
                updateUSMarketDashboard(),
                loadSectorHeatmap()
            ]);

            if (lastUpdateTimeEl) {
                const now = new Date();
                const updateStr = now.toLocaleString('ko-KR', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                lastUpdateTimeEl.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${updateStr}`;
            }
        } catch (e) {
            console.error('Update failed:', e);
            if (lastUpdateTimeEl) {
                lastUpdateTimeEl.textContent = 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨';
            }
        } finally {
            if (updateBtn) {
                updateBtn.disabled = false;
                updateBtn.classList.remove('opacity-50');
            }
            if (updateIcon) {
                updateIcon.classList.remove('fa-spin');
            }
        }
        }

        async function loadSectorHeatmap() {
            const container = document.getElementById('us-sector-heatmap');
            if (!container) return;

            try {
                const response = await fetch('/api/us/sector-heatmap');
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<div class="flex items-center justify-center h-full text-red-400">${data.error}</div>`;
                    return;
                }

                // Clear loading message
                container.innerHTML = '';

                // Check if we have series data
                if (!data.series || data.series.length === 0) {
                    container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">ë°ì´í„° ì—†ìŒ</div>';
                    return;
                }

                const options = {
                    series: data.series,
                    legend: {
                        show: true
                    },
                    chart: {
                        height: 350,
                        type: 'treemap',
                        toolbar: { show: false },
                        background: 'transparent'
                    },
                    title: {
                        text: 'S&P 500 Sector Performance',
                        align: 'center',
                        style: { color: '#fff' }
                    },
                    colors: [
                        '#00C853', '#4CAF50', '#81C784', // Green
                        '#EF9A9A', '#F44336', '#B71C1C'  // Red
                    ],
                    plotOptions: {
                        treemap: {
                            distributed: true,
                            enableShades: false
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        style: { fontSize: '12px' },
                        formatter: function (text, op) {
                            return [text, op.value];
                        }
                    },
                    tooltip: {
                        theme: 'dark',
                        y: {
                            formatter: function (item) {
                                return item;
                            }
                        }
                    }
                };

                const chart = new ApexCharts(container, options);
                chart.render();

            } catch (e) {
                console.error('Error loading heatmap:', e);
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // Update date/time headers
        function updateDateHeaders(analysisDate) {
            const recDateHeader = document.getElementById('rec-date-header');
            const currentDateHeader = document.getElementById('current-date-header');

            if (recDateHeader && analysisDate) {
                recDateHeader.textContent = `(${analysisDate})`;
            }

            if (currentDateHeader) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' });
                const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                currentDateHeader.textContent = `(${dateStr} ${timeStr})`;
            }
        }

        // Reanalyze data function
        async function reanalyzeData() {
            const modal = document.getElementById('reanalyze-modal');
            const progress = document.getElementById('reanalyze-progress');
            const reanalyzeBtn = document.getElementById('reanalyze-btn');
            const updateBtn = document.getElementById('update-data-btn');

            // Disable all buttons
            if (reanalyzeBtn) reanalyzeBtn.disabled = true;
            if (updateBtn) updateBtn.disabled = true;

            // Show modal
            modal.classList.remove('hidden');

            // Simulate progress steps
            setTimeout(() => {
                progress.style.width = '33%';
                document.getElementById('progress-step-1').classList.add('hidden');
                document.getElementById('progress-step-2').classList.remove('hidden');
                document.getElementById('progress-step-2').classList.add('flex');
            }, 10000);

            setTimeout(() => {
                progress.style.width = '66%';
                document.getElementById('progress-step-2').classList.add('hidden');
                document.getElementById('progress-step-3').classList.remove('hidden');
                document.getElementById('progress-step-3').classList.add('flex');
            }, 25000);

            try {
                const response = await fetch('/api/us/reanalyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                // Complete
                progress.style.width = '100%';
                document.getElementById('progress-step-3').classList.add('hidden');
                document.getElementById('progress-complete').classList.remove('hidden');
                document.getElementById('progress-complete').classList.add('flex');

                if (data.success) {
                    setTimeout(async () => {
                        try {
                            // Force reload all data
                            await updateUSMarketDashboard();
                            console.log('Dashboard updated after reanalysis');
                        } catch (e) {
                            console.error('Failed to update dashboard:', e);
                        }
                        modal.classList.add('hidden');
                        // Reset modal for next time
                        setTimeout(() => {
                            progress.style.width = '0%';
                            document.getElementById('progress-step-1').classList.remove('hidden');
                            document.getElementById('progress-step-1').classList.add('flex');
                            document.getElementById('progress-complete').classList.add('hidden');
                        }, 500);
                    }, 2000);
                } else {
                    alert('ì¬ë¶„ì„ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    modal.classList.add('hidden');
                }
            } catch (e) {
                console.error('Reanalyze failed:', e);
                alert('ì¬ë¶„ì„ ì‹¤íŒ¨: ' + e.message);
                modal.classList.add('hidden');
            } finally {
                if (reanalyzeBtn) reanalyzeBtn.disabled = false;
                if (updateBtn) updateBtn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {

            // Check for viewer mode
            const urlParams = new URLSearchParams(window.location.search);
            const isViewerMode = urlParams.get('mode') === 'viewer';

            if (isViewerMode) {
                console.log('Viewer mode activated - read only');

                // Disable control buttons (keep visible)
                const updateBtn = document.getElementById('update-data-btn');
                const reanalyzeBtn = document.getElementById('reanalyze-btn');
                const dateSelect = document.getElementById('us-history-date-select');

                if (updateBtn) {
                    updateBtn.disabled = true;
                    updateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    updateBtn.title = 'ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                }
                if (reanalyzeBtn) {
                    reanalyzeBtn.disabled = true;
                    reanalyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    reanalyzeBtn.title = 'ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                }
                if (dateSelect) {
                    dateSelect.disabled = true;
                    dateSelect.classList.add('opacity-50', 'cursor-not-allowed');
                }

                // Add viewer mode badge
                const header = document.querySelector('header');
                if (header) {
                    const badge = document.createElement('div');
                    badge.className = 'fixed top-4 right-4 bg-blue-600 text-white px-3 py-1 text-xs rounded-full shadow-lg z-50 flex items-center gap-2';
                    badge.innerHTML = '<i class="fas fa-eye"></i> ë·°ì–´ ëª¨ë“œ (ì½ê¸° ì „ìš©)';
                    document.body.appendChild(badge);
                }
            }


            try {
                updateUSMarketDashboard(); // Initial dashboard load
            } catch (e) {
                console.error("Initialization Error:", e);
            }
        });

    </script>

    <!-- Reanalyze Progress Modal -->
    <div id="reanalyze-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-[#1a1a1a] border-2 border-purple-600 rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="mb-4">
                    <i class="fas fa-brain text-purple-500 text-4xl animate-pulse"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">ë°ì´í„° ì¬ë¶„ì„ ì¤‘</h3>
                <p class="text-gray-400 text-sm mb-4">AIê°€ ìƒˆë¡œìš´ Top 10 ì¢…ëª©ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>

                <div class="bg-[#0a0a0a] rounded-full h-4 mb-4 overflow-hidden">
                    <div id="reanalyze-progress"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 h-full transition-all duration-500"
                        style="width: 0%"></div>
                </div>

                <div class="space-y-2 text-left text-xs text-gray-500">
                    <div id="progress-step-1" class="flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <span>ETF ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</span>
                    </div>
                    <div id="progress-step-2" class="hidden items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <span>AI ë¶„ì„ ì‹¤í–‰ ì¤‘...</span>
                    </div>
                    <div id="progress-step-3" class="hidden items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <span>ê²°ê³¼ ì €ì¥ ì¤‘...</span>
                    </div>
                    <div id="progress-complete" class="hidden items-center text-green-400">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>ì™„ë£Œ! ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ ì¤‘...</span>
                    </div>
                </div>

                <p class="text-xs text-gray-600 mt-4">ì˜ˆìƒ ì‹œê°„: 30-60ì´ˆ</p>
            </div>
        </div>
    </div>


    <!-- DEBUG & HOTFIX SCRIPT -->
    <script>
        // DEBUG: On-screen logging helper
        window.logDebug = function (msg) {
            console.log(msg);
            const debugEl = document.getElementById('debug-console');
            if (debugEl) {
                const time = new Date().toLocaleTimeString();
                debugEl.innerHTML += `<div>[${time}] ${msg}</div>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        };

        // Initialize Debug Console
        (function () {
            if (!document.getElementById('debug-console')) {
                const consoleDiv = document.createElement('div');
                consoleDiv.id = 'debug-console';
                consoleDiv.style.cssText = 'position:fixed; top:60px; left:10px; width:300px; height:200px; background:rgba(0,0,0,0.85); color:#00ff00; font-family:monospace; font-size:11px; overflow-y:auto; z-index:99999; border:1px solid #444; padding:5px; pointer-events:none;';
                document.body.appendChild(consoleDiv);
                logDebug("Debug Console Started (Hotfix v2)");
            }
        })();

        // Redefine loadUSStockChart with debug logging (Overwrites previous definition)
        window.loadUSStockChart = async function (pick, idx, period = null) {
            const chartContainer = document.getElementById('us-stock-chart');
            const tickerEl = document.getElementById('us-chart-ticker');
            const infoEl = document.getElementById('us-chart-info');
            const gradeEl = document.getElementById('us-chart-grade');

            if (!chartContainer) return;

            // Save current pick
            currentChartPick = pick;
            const usePeriod = period || currentChartPeriod;

            // Update header
            if (tickerEl) tickerEl.textContent = pick.ticker;
            const score = pick.final_score || pick.composite_score || 0;
            if (infoEl) infoEl.textContent = `${pick.name || pick.ticker} | Score: ${score}/100`;

            const aiRec = pick.ai_recommendation || 'ë¶„ì„ ì¤‘';
            let displayRec = aiRec;
            let bgClass = 'bg-gray-600';

            if (aiRec.toLowerCase().includes('strong buy') || aiRec.includes('ì ê·¹')) {
                displayRec = 'ì ê·¹ ë§¤ìˆ˜';
                bgClass = 'bg-yellow-600';
            } else if (aiRec.toLowerCase().includes('buy') || aiRec.includes('ë§¤ìˆ˜')) {
                displayRec = 'ë§¤ìˆ˜';
                bgClass = 'bg-green-600';
            }

            if (gradeEl) {
                gradeEl.textContent = displayRec;
                gradeEl.className = `px-3 py-1 rounded text-sm font-bold ${bgClass} text-white`;
            }

            // Update details panel
            if (typeof updateUSStockDetails === 'function') updateUSStockDetails(pick);

            // Highlight selected row
            if (idx >= 0) {
                document.querySelectorAll('#us-smart-money-table tr').forEach(tr => {
                    tr.classList.remove('bg-[#2a2a2a]');
                });
                const rows = document.querySelectorAll('#us-smart-money-table tr');
                if (rows[idx]) rows[idx].classList.add('bg-[#2a2a2a]');
            }

            // --- Chart Loading Logic ---
            try {
                logDebug(`Loading chart for ${pick.ticker} (${usePeriod})...`);

                // Force container height
                chartContainer.style.height = '300px';
                chartContainer.style.position = 'relative';

                chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> <span class="ml-2">Loading Chart...</span></div>';

                // Wait a bit to ensure library load
                if (typeof LightweightCharts === 'undefined') {
                    logDebug("Waiting for LightweightCharts...");
                    await new Promise(r => setTimeout(r, 1000)); // wait 1s
                }

                // Ensure Library is loaded
                if (typeof LightweightCharts === 'undefined') {
                    logDebug("ERROR: LightweightCharts lib not found!");
                    chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-500 flex-col"><i class="fas fa-exclamation-triangle mb-2"></i><span>Chart Library Not Loaded</span><span class="text-xs text-gray-400 mt-1">Check internet connection or CDN</span></div>';
                    return;
                }

                logDebug(`Fetching chart data...`);
                const response = await fetch(`/api/us/stock-chart/${pick.ticker}?period=${usePeriod}`);
                if (!response.ok) {
                    logDebug(`API Error: ${response.status}`);
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                logDebug(`Data received. Candles: ${data.candles ? data.candles.length : 0}`);

                if (data.error) {
                    logDebug(`Data has error: ${data.error}`);
                    chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">${data.error}</div>`;
                    return;
                }

                if (!data.candles || data.candles.length === 0) {
                    logDebug("No candles data found");
                    chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">No price data for ${pick.ticker}</div>`;
                    return;
                }

                // Clear container and create chart
                chartContainer.innerHTML = '';

                // Dispose previous chart if exists
                if (window.usStockChart) {
                    try {
                        window.usStockChart.remove();
                    } catch (e) { console.warn("Chart remove error", e); }
                    window.usStockChart = null;
                }

                // Double check container dimensions
                const containerWidth = chartContainer.clientWidth || chartContainer.parentElement.clientWidth || 600;
                const containerHeight = chartContainer.clientHeight || 300;
                logDebug(`Creating chart: ${containerWidth}x${containerHeight}`);

                window.usStockChart = LightweightCharts.createChart(chartContainer, {
                    width: containerWidth,
                    height: containerHeight,
                    layout: { background: { color: '#1a1a1a' }, textColor: '#999' },
                    grid: { vertLines: { color: '#2a2a2a' }, horzLines: { color: '#2a2a2a' } },
                    timeScale: {
                        borderColor: '#2a2a2a',
                        timeVisible: true,
                        rightOffset: 5,
                        fixLeftEdge: true,
                        fixRightEdge: true
                    },
                    rightPriceScale: { borderColor: '#2a2a2a' },
                    handleScroll: false,
                    handleScale: false
                });

                const candleSeries = window.usStockChart.addCandlestickSeries({
                    upColor: '#22c55e',
                    downColor: '#ef4444',
                    borderUpColor: '#22c55e',
                    borderDownColor: '#ef4444',
                    wickUpColor: '#22c55e',
                    wickDownColor: '#ef4444'
                });

                candleSeries.setData(data.candles);
                window.usStockChart.timeScale().fitContent();
                logDebug("Chart rendered successfully");

            } catch (e) {
                console.error('Error loading chart:', e);
                logDebug(`Chart Error: ${e.message}`);
                chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-red-500">Error: ${e.message}</div>`;
            }
        };
    </script>
</body>

</html>